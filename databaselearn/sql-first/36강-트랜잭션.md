# 36강 - 트랜잭션
```SQL
START TRANSACTION
COMMIT
ROLLBACK
```
데이터베이스는 트랜잭션이라는 기능을 제공합니다. INSERT나 UPDATE 명령으로 데이터를 추가, 갱신할 때도 트랜잭션 기능을 사용합니다만 지금까지 특별히 의식할 필요는 없었습니다.  
이는 자동 커밋이라 불리는 기능이 동작했기 때문입니다. 여기서는 트랜잭션으로 어떤 것을 할 수 있는지 알아보겠습니다.  
  
## 1. 트랜잭션
정규화로 인해 분할된 주문 테이블과 주문상품 테이블의 관계를 생각해보겠습니다.  
  
주문 테이블에 행이 존재한다면 주문상품 테이블에는 적어도 하나의 행이 존재해야 합니다.  
그렇지 않으면 주문한 상품이 없는데도 주문이 된 상태가 됩니다.  
  
주문이 발생했을 때(발주처리), 먼저 주문번호를 지정해야 합니다.  
이때 기존 주문과 구분되는 주문번호를 발행하는 처리가 필요합니다.  
  
자동 증가를 사용하면 자동적으로 번호가 부여됩니다만 그렇지 않은 경우에는 '번호 중 가장 큰 값을 SELECT 명령으로 가져와 그 값에 1을 더한다' 라는 처리가 필요합니다.  
최대값은 MAX()로 검색할 수 있으므로 'MAX + 1'이라 할 수도 있습니다.  
  
번호를 발행 받았다면 해당 번호를 키로 삼아 INSERT가 이루어집니다. 주문 테이블에는 INSERT 한 번, 주문상품 테이블에는 주문된 상품 수만큼 INSERT 명령이 실행됩니다.  
중요한 것은 복수의 테이블에 INSERT 되므로 실행되는 명령은 최소 두 번이라는 것입니다.  
```SQL
INSERT INTO 주문 VALUES(4, '2014-03-01', 1);
INSERT INTO 주문상품 VALUES(4, '0003', 1);
INSERT INTO 주문상품 VALUES(4, '0004', 2);
```
여기서 INSERT 명령이 특정 원인으로 인해 에러가 발생한 경우를 가정해봅시다.  
트랜잭션 기능을 사용하지 않을 때는 문제없이 실행된 INSERT 명령을 실행 전으로 되돌릴 수 없으므로 따로 DELETE 명령을 실행해 지워야합니다.  
즉, 세 번째 INSERT 명령에서 에러가 발생했다고 치면, 앞서 실행한 두 개의 INSERT 명령에 의해 추가된 데이터를 DELETE 명령으로 삭제하는 처리가 필요합니다. 이것은 아주 번거로운 작업입니다.  
  
## 2. 롤백과 커밋
이처럼 몇 단계로 처리를 나누어 SQL 명령을 실행하는 경우에 트랜잭션을 자주 사용합니다.  
트랜잭션을 사용해 데이터를 추가한다면 에러가 발생해도 트랜잭션을 롤백해서 종료할 수 있습니다.  
롤백하면 [트랜잭션 내에서 행해진 모든 변경사항을 없었던 것으로 할 수 있습니다]  
아무런 에러가 발생하지 않는다면, [변경사항을 적용하고 트랜잭션을 종료하는데 이때 커밋을 사용]합니다.  
  
트랜잭션을 사용해서 데이터를 추가할 때는 자동커밋을 꺼야 합니다. mysql 클라이언트에서 명령을 실행할 때는 자동커밋이 켜저 있는 상태입니다.  
자동커밋을 끄기 위해서는 명시적으로 트랜잭션의 시작을 선언할 필요가 있습니다. **START TRANSACTION** 명령을 사용합니다.  
  
변경된 내용을 적용한 후에 종료하는 커밋과(COMMIT), 적용하지 않고 종료하는 '롤백(ROLLBACK)'의 두 가지 방식이 있습니다.  
  
트랜잭션 내에서 실행된 SQL 명령은 임시 데이터 영역에서 수행되다가, COMMIT 명령을 내리면 임시 데이터 영역에서 정식 데이터 영역으로 변경이 적용된다고 생각하시면 됩니다.  
ROLLBACK 명령을 내리면 임시 데이터 영역에서의 처리는 버려집니다.  
  
'트랜잭션을 걸어서 처리한다', '트랜잭션 내에서 실행한다' 라고 합니다.  
## 3. 트랜잭션 사용법
트랜잭션 내에서 실행하는 복수의 SQL 명령은 세트 단위로 유효/무효가 됩니다.  
에러가 발생하지 않아도 ROLLBACK을 하면 변경한 내용은 파기됩니다.  
반대로 에러가 발생하더라도 COMMIT을 하면 문제없이 실행된 SQL 명령의 변경사항은 데이터베이스에 그대로 반영됩니다.  
  
자동커밋은 클라이언트 툴의 기능입니다. 미들웨어(서로 다른 애플리케이션이 통신하는 데 사용되는 소프트웨어)도 데이터베이스 접속 시 대개 자동커밋을 합니다.  
  
한편, 데이터베이스 서버에서는 언제나 트랜잭션을 걸 수 있는 상태로 SQL 명령이 실행됩니다.  
  
ROLLBACK으로 취소할 수 있는 것은 트랜잭션 내에서 실행했을 경우에 한합니다.  
